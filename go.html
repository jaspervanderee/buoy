<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Redirecting... | Buoy Bitcoin</title>
  <meta name="robots" content="noindex, nofollow">
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
      background-color: #f9f9f9;
      color: #333;
      text-align: center;
    }
    .container {
      padding: 2rem;
    }
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #333;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    p { margin-top: 1rem; color: #666; }
    .error { color: #d00; }
  </style>
</head>
<body>
  <div class="container">
    <div class="spinner" id="spinner"></div>
    <p id="status">Redirecting you to the service...</p>
  </div>

  <script>
    (async function() {
      const params = new URLSearchParams(window.location.search);
      const serviceName = params.get('service');
      const target = params.get('target') || 'website';
      const explicitUrl = params.get('url');
      const statusEl = document.getElementById('status');
      const spinnerEl = document.getElementById('spinner');

      // 1. If explicit URL is provided, redirect immediately
      if (explicitUrl) {
        try {
          // Decode if it looks encoded, though URLSearchParams handles most
          // Simple check: if it starts with http, use it.
          if (explicitUrl.startsWith('http') || explicitUrl.startsWith('itms') || explicitUrl.startsWith('market')) {
            window.location.replace(explicitUrl);
            return;
          }
        } catch (e) {
          console.error("Invalid URL param", e);
        }
      }

      // 2. Need to look up service data
      if (!serviceName) {
        showError("Missing service parameter.");
        return;
      }

      try {
        const response = await fetch('/data/services.json');
        if (!response.ok) throw new Error("Could not load service data.");
        
        const services = await response.json();
        const service = services.find(s => s.name.toLowerCase() === serviceName.toLowerCase());

        if (!service) {
          showError(`Service "${serviceName}" not found.`);
          return;
        }

        // Determine destination
        let dest = service.website; // Default fallback

        if (target === 'website') {
          dest = service.website;
        } else if (target === 'ios') {
          dest = service.links && service.links.ios ? service.links.ios : service.website;
        } else if (target === 'android') {
          dest = service.links && service.links.android ? service.links.android : service.website;
        } else if (target === 'auto') {
          // Detect platform
          const ua = navigator.userAgent || navigator.vendor || window.opera;
          const isIOS = /iPad|iPhone|iPod/.test(ua) && !window.MSStream;
          const isAndroid = /android/i.test(ua);

          if (isIOS && service.links && service.links.ios) {
            dest = service.links.ios;
          } else if (isAndroid && service.links && service.links.android) {
            dest = service.links.android;
          } else {
            dest = service.website;
          }
        }

        // Redirect
        if (dest) {
          // Analytics (optional, if window.umami exists)
          if (window.umami) {
             window.umami.track('redirect_go', { service: serviceName, target: target, url: dest });
          }
          window.location.replace(dest);
        } else {
          showError("No destination URL found for this service.");
        }

      } catch (err) {
        console.error(err);
        showError("Unable to redirect. Please try again later.");
      }

      function showError(msg) {
        spinnerEl.style.display = 'none';
        statusEl.textContent = msg;
        statusEl.className = 'error';
      }
    })();
  </script>
  <!-- Umami Analytics (optional, inherited from site) -->
  <script defer src="https://cloud.umami.is/script.js" data-website-id="0895676a-bb0e-488d-9381-a27cf9cf5888" data-domains="buoybitcoin.com,www.buoybitcoin.com"></script>
</body>
</html>